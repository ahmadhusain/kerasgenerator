---
title: "Data Generator for Time Series Model"
author: "R. Dimas Bagas Herlambang"
date: "`r Sys.Date()`"
bibliography: bibliography.bib
csl: apa.csl
link-citations: yes
output:
  rmarkdown::html_vignette:
    fig_caption: no
vignette: >
  %\VignetteIndexEntry{Data Generator for Time Series Model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  out.width = "100%"
)
```

# Introduction to Data Generator for Time Series Model

Preparing a proper dataset for a supervised time series model sometimes could become very complex and tedious. There are some tutorials that already cover this kind of task: check out the tutorial made by [Dancho and Keydana](https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/) [-@dancho2018predicting] for basic univariate model fitting without using data generator, and the one made by [Chollet and Allaire](https://blogs.rstudio.com/tensorflow/posts/2017-12-20-time-series-forecasting-with-recurrent-neural-networks/) [-@chollet2017time] for the multivariate model with a custom data generator. However, as you could see from the articles, there are no general framework on how to properly do the data preparation process.

In this article we will show you how `kerasgenerator` could help us in preparing a data generator for supervised time series [`keras`](https://keras.rstudio.com) models.

## Understanding the Time Series Array Shape

To fit a supervised time series model, many of `keras`' functions expect the target and feature data to be in an `array` object with a specific number of dimension. The input and output `array` need to have at least three dimension that representing:

1. Observation index
2. Number of timesteps
3. Number of distinct feature / target

You can imagine the `array` shape to be like this:

<!-- insert image -->

To understand better what each dimensions representing, let's follow a quick example using the popular [Sunspots](http://www.sidc.be/silso/datafiles) dataset [@sidc]. We will use the monthly total mean version:

```{r, message=FALSE, warning=FALSE}

# import libs
library(tidyverse)

# import dataset
sunspot_tbl <- read_delim("data/SN_m_tot_V2.0.csv", delim = ";", col_names = FALSE)

# quick check
glimpse(sunspot_tbl)

```

The dataset is in a general time series format--it contains a time identifier column, each row representing a timestep, and it is regularly ordered. Before we move further, let's do a quick data preprocess:

```{r, message=FALSE, warning=FALSE}

# import libs
library(lubridate)
library(magrittr)

# data preprocess
sunspot_tbl %<>%

  # select and rename relevant variables
  select(year = X1, month = X2, sunspots = X4) %>%

  # some data manipulation
  mutate(
    date = paste(year, month, "01", sep = "-") %>% ymd(),
    sunspots = str_squish(sunspots) %>% as.numeric()
  ) %>%

  # keep only relevant variables
  select(date, sunspots)

# quick check
glimpse(sunspot_tbl)

```

In supervised time series model, we need to define two important parameters for our datasets. The first parameter is the **lookback period**. The lookback period is determining **how many period behind should the targets look-up for its signal**, but it should be noted that **the periods in-between will be ignored**. The second parameter is the **timestep length**. This parameter define the length of an observation of features that would be considered as a sequence of signal for the target.

```{r, message=FALSE, warning=FALSE}

# import libs
library(tidyquant)

# set some parameters
lookback <- 12
timesteps <- 12

# specify the target and feature
target <- tail(sunspot_tbl$date, 1)
feature_end <- target - months(lookback)
feature_start <- feature_end - months(timesteps) + months(1)

# illustration
sunspot_tbl %>%
  tail(30) %>%
  mutate(
    label = case_when(
      date == target ~ "Target",
      date %in% seq(feature_start, feature_end, by = "1 month") ~ "Feature",
      TRUE ~ "Ignored"
    )
  ) %>%
  ggplot(aes(x = date, y = sunspots)) +
    geom_line() +
    geom_point(aes(colour = label)) +
    annotate(
      geom = "rect",
      xmin = feature_start, xmax = feature_end,
      ymin = -Inf, ymax = Inf,
      alpha = 0.1, fill = "#2c3e50"
    ) +
    annotate(
      geom = "text",
      x = feature_start, y = 47.5,
      label = expression("One observation of feature\nwith 12 timesteps"),
      colour = "#2c3e50",
      hjust = -0.1375
    ) +
    annotate(
      geom = "text",
      x = target, y = 16.5,
      label = "One observation of target",
      colour = "#18BC9C",
      hjust = 0.05,
      angle = 90
    ) +
    annotate(
      geom = "segment",
      x = target, xend = target,
      y = 15, yend = 7.5,
      colour = "#18BC9C",
      arrow = arrow()
    ) +
    labs(x = "", y = "", colour = "") +
    theme_tq() +
    scale_colour_tq()

```

# Data Generator for Univariate Time Series

# Data Generator for Multivariate Time Series

# References
